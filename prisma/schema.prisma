generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model Tenant {
  id               String             @id @default(uuid())
  name             String
  businessId       String
  settingsJson     Json?
  createdAt        DateTime           @default(now())
  updatedAt        DateTime           @updatedAt
  deletedAt        DateTime?
  drivers          DriverProfile[]
  FixedPricePolicy FixedPricePolicy[]
  invitations      Invitation[]
  memberships      Membership[]
  oauthStates      OAuthState[]
  payments         Payment[]
  pricing          PricingPolicy[]
  providerAccts    ProviderAccount[]
  rides            Ride[]
  receipts         Receipt[]
  numberSequences  NumberSequence[]
  exportArchives   ExportArchive[]
  vivaAccount      VivaAccount?       @relation("TenantVivaAccount")

  @@index([businessId])
}

model User {
  id            String         @id @default(uuid())
  email         String         @unique
  createdAt     DateTime       @default(now())
  updatedAt     DateTime       @updatedAt
  passwordHash  String
  status        UserStatus
  driverProfile DriverProfile?
  invitations   Invitation[]
  memberships   Membership[]
}

model Membership {
  id        String   @id @default(uuid())
  userId    String
  tenantId  String
  role      Role
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  tenant    Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@unique([userId, tenantId])
  @@index([tenantId, role])
  @@index([userId])
}

model Invitation {
  id              String         @id @default(uuid())
  tenantId        String
  email           String
  role            Role
  token           String         @unique
  expiresAt       DateTime
  acceptedAt      DateTime?
  invitedByUserId String?
  driverProfileId String?
  driverProfile   DriverProfile? @relation(fields: [driverProfileId], references: [id])
  invitedByUser   User?          @relation(fields: [invitedByUserId], references: [id])
  tenant          Tenant         @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@index([tenantId])
}

model DriverProfile {
  id               String             @id @default(uuid())
  tenantId         String
  userId           String             @unique
  firstName        String
  lastName         String
  phone            String?
  status           String
  email            String
  tenant           Tenant             @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  user             User               @relation(fields: [userId], references: [id], onDelete: Cascade)
  FixedPricePolicy FixedPricePolicy[]
  invitations      Invitation[]
  rides            Ride[]

  @@index([tenantId])
}

model PricingPolicy {
  id        String   @id @default(uuid())
  tenantId  String
  name      String
  baseFare  Decimal  @db.Decimal(10, 2)
  perKm     Decimal  @db.Decimal(10, 4)
  isActive  Boolean  @default(false)
  createdAt DateTime @default(now())
  updatedAt DateTime @default(now()) @updatedAt
  perMin    Decimal  @default(0.000) @db.Decimal(10, 3)
  tenant    Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  ride      Ride[]

  @@index([tenantId, isActive])
  @@index([tenantId, updatedAt])
}

model FixedPricePolicy {
  id              String         @id @default(uuid())
  tenantId        String
  driverProfileId String?
  name            String
  amount          Decimal        @db.Decimal(10, 2)
  isActive        Boolean        @default(true)
  createdAt       DateTime       @default(now())
  createdByUserId String?
  driverProfile   DriverProfile? @relation(fields: [driverProfileId], references: [id], onDelete: Cascade)
  tenant          Tenant         @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  rides           Ride[]

  @@index([tenantId, isActive])
  @@index([tenantId, driverProfileId])
}

model Ride {
  id                 String            @id @default(uuid())
  status             RideStatus
  distanceKm         Decimal?          @db.Decimal(10, 3)
  driverProfileId    String
  durationMin        Decimal?          @db.Decimal(10, 2)
  endedAt            DateTime?
  fareSubtotal       Decimal?          @db.Decimal(10, 2)
  fareTotal          Decimal?          @db.Decimal(10, 2)
  pricingPolicyId    String?
  startedAt          DateTime
  taxAmount          Decimal?          @db.Decimal(10, 2)
  tenantId           String
  customFixedFare    Decimal?          @db.Decimal(10, 2)
  fixedPricePolicyId String?
  pricingMode        RidePricingMode   @default(METER)
  payment            Payment?
  links              PaymentLink[]
  receipts           Receipt?
  driverProfile      DriverProfile     @relation(fields: [driverProfileId], references: [id], onDelete: Cascade)
  fixed              FixedPricePolicy? @relation(fields: [fixedPricePolicyId], references: [id])
  pricing            PricingPolicy?    @relation(fields: [pricingPolicyId], references: [id])
  tenant             Tenant            @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  webhookEvents      WebhookEvent[]

  @@index([tenantId, status])
  @@index([driverProfileId])
  @@index([startedAt])
  @@index([tenantId, endedAt])
}

model Payment {
  id                String          @id @default(uuid())
  rideId            String          @unique
  tenantId          String
  provider          PaymentProvider
  amount            Decimal         @db.Decimal(10, 2)
  taxAmount         Decimal?        @db.Decimal(10, 2)
  netAmount         Decimal?        @db.Decimal(10, 2)
  currency          String          @default("EUR")
  status            PaymentStatus
  createdAt         DateTime        @default(now())
  authorizedAt      DateTime?
  capturedAt        DateTime?
  failureCode       String?
  externalPaymentId String?
  invoiceNumber     String?
  numberPeriod      String?
  receiptNumber     String?
  approvalCode      String?
  providerMetadata  Json?
  ride              Ride            @relation(fields: [rideId], references: [id], onDelete: Cascade)
  tenant            Tenant          @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  receipts          Receipt[]
  webhookEvents     WebhookEvent[]

  @@unique([tenantId, numberPeriod, receiptNumber])
  @@unique([tenantId, numberPeriod, invoiceNumber])
  @@index([tenantId, status])
  @@index([tenantId, capturedAt])
  @@index([tenantId, status, capturedAt])
  @@index([externalPaymentId])
}

model Receipt {
  id        String    @id @default(uuid())
  tenantId  String
  rideId    String    @unique
  paymentId String
  publicId  String    @unique
  status    String
  issuedAt  DateTime
  expiresAt DateTime?
  pdfUrl    String?
  dataJson  Json
  payment   Payment   @relation(fields: [paymentId], references: [id], onDelete: Cascade)
  ride      Ride      @relation(fields: [rideId], references: [id], onDelete: Cascade)
  tenant    Tenant    @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@index([tenantId])
}

model NumberSequence {
  id        String             @id @default(uuid())
  tenantId  String
  type      NumberSequenceType
  period    String
  current   Int
  createdAt DateTime           @default(now())
  tenant    Tenant             @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@unique([tenantId, type, period])
}

model ExportArchive {
  id              String            @id @default(uuid())
  tenantId        String
  period          String
  type            ExportArchiveType
  createdAt       DateTime          @default(now())
  createdByUserId String
  pdfPath         String
  jsonPath        String
  sha256          String
  count           Int
  totalAmount     Decimal           @db.Decimal(10, 2)
  tenant          Tenant            @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@index([tenantId, period, type])
}

model PaymentLink {
  id        String          @id @default(uuid())
  rideId    String
  provider  PaymentProvider
  url       String
  status    String
  createdAt DateTime        @default(now())
  expiresAt DateTime?
  ride      Ride            @relation(fields: [rideId], references: [id], onDelete: Cascade)

  @@index([rideId, status])
}

model ProviderAccount {
  id                String          @id @default(uuid())
  tenantId          String
  provider          PaymentProvider
  externalAccountId String
  accessTokenEnc    String?
  refreshTokenEnc   String?
  scope             String?
  livemode          Boolean         @default(false)
  connectedAt       DateTime?
  metadataJson      Json?
  tenant            Tenant          @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@unique([tenantId, provider])
}

model VivaAccount {
  id          String   @id @default(uuid())
  tenantId    String   @unique
  provider    PaymentProvider
  merchantId  String
  liveMode    Boolean  @default(false)
  connectedAt DateTime

  tenant Tenant @relation("TenantVivaAccount", fields: [tenantId], references: [id])

  @@index([tenantId, merchantId])
}

model WebhookEvent {
  id           String          @id @default(uuid())
  provider     PaymentProvider
  eventType    String
  externalId   String          @unique
  receivedAt   DateTime        @default(now())
  payloadJson  Json
  processedAt  DateTime?
  attemptCount Int             @default(0)
  paymentId    String?
  rideId       String?
  errorMessage String?
  payment      Payment?        @relation(fields: [paymentId], references: [id])
  ride         Ride?           @relation(fields: [rideId], references: [id])

  @@index([provider, eventType])
  @@index([paymentId])
  @@index([rideId])
  @@index([receivedAt])
}

model OAuthState {
  id        String          @id @default(uuid())
  nonce     String          @unique
  tenantId  String
  userId    String
  provider  PaymentProvider
  createdAt DateTime        @default(now())
  expiresAt DateTime
  consumed  Boolean         @default(false)
  tenant    Tenant          @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@index([nonce])
  @@index([expiresAt])
  @@index([tenantId, provider])
}

enum Role {
  ADMIN
  DRIVER
  MANAGER
}

enum RideStatus {
  DRAFT
  ONGOING
  COMPLETED
  CANCELLED
}

enum PaymentProvider {
  CASH
  VIVA
}

enum PaymentStatus {
  REQUIRES_ACTION
  PENDING
  PAID
  FAILED
  REFUNDED
  SUBMITTED
}

enum PaymentMethod {
  CASH
  CARD
}

enum PaymentProviderStatus {
  CONNECTED
  PENDING
  DISCONNECTED
}

enum NumberSequenceType {
  RECEIPT
  INVOICE
}

enum ExportArchiveType {
  simplified
  full
}

enum RidePricingMode {
  METER
  FIXED_PRICE
  CUSTOM_FIXED
}

enum UserStatus {
  ACTIVE
  OFFLINE
}
